name: CI/CD to Render

on:
    push:
        branches:
            - main

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm install

            - name: Run tests
              run: npm test

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-test
        if: success() # Chỉ chạy nếu job test thành công
        env:
            RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
            RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        steps:
            - name: Deploy to Render # trying to deploy
              run: |
                  curl -X POST \
                    -H "Accept: application/json" \
                    -H "Authorization: Bearer $RENDER_API_KEY" \
                    "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys"

    notify:
        runs-on: ubuntu-latest
        needs: [build-and-test, deploy]
        if: always() # Luôn chạy dù pass hay fail
        steps:
            - name: Send email notification
              uses: dawidd6/action-send-mail@v3
              with:
                  server_address: smtp.gmail.com
                  server_port: 587
                  username: ${{ secrets.EMAIL_USER }}
                  password: ${{ secrets.EMAIL_PASS }}
                  subject: |
                      Deploy ${{ github.repository }} - ${{ job.status }}
                  body: |
                      Repository: ${{ github.repository }}
                      Branch: ${{ github.ref_name }}
                      Status: ${{ job.status }}
                      Commit: ${{ github.sha }}
                  to: ${{ secrets.EMAIL_TO }}
                  from: GitHub Actions <${{ secrets.EMAIL_USER }}>
